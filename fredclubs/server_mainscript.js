var NightClubs = [
    {
        id: 1,
        coords: [194.859619, -3167.304, 5.790269851],
        pedHeading: 90,
        name: "Elysian Island",
        blipTextLabel: "NightclubsBlipName_1",
        description: "Forget homely blue-collar neighborhoods and picturesque abandoned factories. If you want a real challenge, try gentrifying a dockside slum that's knee-deep in industrial discharge and dead fish. If you can bring the A-listers here, you can bring them anywhere.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 16, // 1-16
        interiorStyle: 1, // 1-4
        djStyle: 4, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 2,
        coords: [-676.9856567382812, -2458.77294921874, 13.944400787353516],
        pedHeading: 90,
        name: "LSIA",
        blipTextLabel: "NightclubsBlipName_1",
        description: "Imagine you're an international businessperson looking for a world-class night out, but you'd rather not stray too far from your private jet in case the FIB hears you're on American soil. There's only one way to cater to that vital demographic, and this location is it.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 16, // 1-16
        interiorStyle: 1, // 1-4
        djStyle: 2, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 3,
        coords: [-1173.8505859374, -1153.390869140625, 5.657962799072266],
        pedHeading: 304,
        name: "Vespucci Canals",
        blipTextLabel: "NightclubsBlipName_1",
        description: "There's only one thing needed to push the Vespucci Canals into being more European than Europe, and that's a wildly pretentious and brutally overpriced nightclub set amid the ruins of once-profitable commerce and industry.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 15, // 1-16
        interiorStyle: 1, // 1-4
        djStyle: 3, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 4,
        coords: [870.64013, -2100.448730, 30.4558963],
        pedHeading: 90,
        name: "Cypress Flats",
        blipTextLabel: "NightclubsBlipName_1",
        description: "Cypress Flats is currently in that perfect sweet spot for a new club, it has barrels overflowing with post-industrial cool, but very little housing, so there's nowhere for the hipsters to roost. This place is staying on the edge for years to come.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 10, // 1-16
        interiorStyle: 2, // 1-4
        djStyle: 3, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 5,
        coords: [345.8825988769531, -977.84814453125, 29.375164031982422],
        pedHeading: 270,
        name: "Mission Row",
        blipTextLabel: "NightclubsBlipName_1",
        description: "A wise man once said that wealth is relative. And nothing will accentuate the astonishing wealth of your clientele like stepping out for a cigarette and gazing compassionately at the highest concentration of vagrancy in the stage.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 0.65,
        nearbyZone: 50, 
        djLightsStyle: 13, // 1-16
        interiorStyle: 2, // 1-4
        djStyle: 3, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 6,
        coords: [758.0218505859375, -1332.5600000, 27.27522850033621],
        pedHeading: 270,
        name: "La Mesa",
        blipTextLabel: "NightclubsBlipName_1",
        description: "As well as being walking distance for the young professionals in Mirror Park, this is also the only location in town where the roar of the interstate doubles as the world's biggest sub-woofer.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 0.48,
        nearbyZone: 50, 
        djLightsStyle: 9, // 1-16
        interiorStyle: 2, // 1-4
        djStyle: 1, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 7,
        coords: [-120.69123077, -1258.66028432904, 29.304134234],
        pedHeading: 270,
        name: "Strawberry",
        blipTextLabel: "NightclubsBlipName_1",
        description: "One of the little-known perks of setting up a nightclub in a disused paint factory is the presence of high residual levels of industrial solvent. Good atmosphere, happy patrons, all night, guaranteed.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 10, // 1-16
        interiorStyle: 3, // 1-4
        djStyle: 4, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 8,
        coords: [-1285.7475597, -651.4150390, 26.58375358],
        pedHeading: 30,
        name: "Del Perro",
        blipTextLabel: "NightclubsBlipName_1",
        description: "This charming 20's style building in Del Perro has just enough residual class to offer a post-ironic thrill when you turn it into a throbbing techno dungeon.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1.5,
        nearbyZone: 50, 
        djLightsStyle: 16, // 1-16
        interiorStyle: 3, // 1-4
        djStyle: 3, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 9,
        coords: [371.3033447265625, 253.2254333490938, 103.0097427368164],
        pedHeading: 0,
        name: "Downtown Vinewood",
        blipTextLabel: "NightclubsBlipName_1",
        description: "Downtown Vinewood is the entertainment capital of Los Santos: Oriental Theater, Whirligig Theater, Doppler Cinema - and right in the heart of it, basking in all its abandoned commercial chic, there's a nightclub location with your name on it.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 15, // 1-16
        interiorStyle: 3, // 1-4
        djStyle: 2, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 10,
        coords: [4.677425384521484, 220.2642648468017578, 107.51250915527344],
        pedHeading: 30,
        name: "West Vinewood",
        blipTextLabel: "NightclubsBlipName_1",
        description: "It's hard to find a suitably scuzzy location in West Vinewood. This place was actually in pristine condition until we paid some drifters to live in it for a couple months: now it has all the character it needs, and then some.",
        blipColor: null,
        blipSprite: null,
        markerColor: null,
        enterZone: 1,
        nearbyZone: 50, 
        djLightsStyle: 14, // 1-16
        interiorStyle: 3, // 1-4
        djStyle: 4, //1-4, which dj posters should be on the walls
        miscProps: [ // https://web.archive.org/web/20191207165505/https://wiki.rage.mp/index.php?title=Interior_Props
            'Int01_ba_trophy11',
            'Int01_ba_trad_lights',
            'Int01_ba_booze_03',
            'Int01_ba_bar_content',
            'Int01_ba_Screen',
            'int01_ba_lights_screen',
            'Int01_ba_deliverytruck',
            'Int01_ba_dry_ice',
            'Int01_ba_equipment_setup',
            'Int01_ba_security_upgrade',
            'Int01_ba_lightgrid_01'
        ]
    },
    {
        id: 11,
        coords: [15.34983052, 6436.1967773437, 31.425300598144],
        pedHeading: 30,
        name: "Paleto Bay (Under Construction)",
        blipTextLabel: "NightclubsBlipName_1",
        description: null,
        blipColor: null,
        blipSprite: null,
        markerColor: [100, 220, 100, 255],
        enterZone: 1,
        nearbyZone: 40, 
        djLightsStyle: null, // 1-16
        interiorStyle: 4, // 1-4
        djStyle: null, //1-4, which dj posters should be on the walls
        miscProps: null
    }
];
var Sessions = new Map();
var Wait = (ms) => new Promise(res => setTimeout(res, ms ? ms : TickRate));

NightClubs.forEach(club => {
    Sessions.set(club.id, {
        Club: club,
        Players: []
    });
});

function SendClubsToClient(source) {
    emitNet('Nightclubs:ClubsReceived', source, JSON.stringify(NightClubs))
}

onNet('Nightclubs:ClubsRequest', () => {
    var source = global.source;
    SendClubsToClient(source);
});

function GetNightclubById (id) {
    if (!id) return false;
    return NightClubs.find(n => n.id === id);
} 

function GetNightclubsExcluding(id) {
    if (!id) return false;
    return NightClubs.filter(nc => nc.id !== id);
}

function AddPlayerToNightclubSession(source, club) {
    if (!Sessions.has(club.id)) return false;
    
    var Session = Sessions.get(club.id);
    Session.Players.push({
        name: GetPlayerName(source),
        id: source, 
        enteredAt: Date.now()
    });
    Sessions.delete(club.id);
    Sessions.set(club.id, Session);

    return Sessions;
}

function GetPlayersFromNightclubsExcluding(clubId) {
    if (!clubId) return false;

    var Players = [];
    Sessions.forEach(async Session => {
        if (Session.Club.id !== clubId) {
            var _Players = Session.Players;
            Players = Players.concat(_Players);
        }
    });

    console.log('GetPlayersFromNightclubsExcluding:')
    console.log(Players)

    return Players;
}

function AcceptEnterRequest(source, club) {
    console.log('accepting enter req')
    AddPlayerToNightclubSession(source, club);
    var Players = GetPlayersFromNightclubsExcluding(club.id);
    emitNet("Nightclubs:EnterRequestAccepted", source, JSON.stringify(Players));
    var Time = 0;
    Players.forEach(async p => {

        console.log(`Sending request to hide ${source} ${GetPlayerName(source)} (player who just entered) to player ${p.id} (${GetPlayerName(p)})`);
        emitNet("Nightclubs:HidePlayer", p.id, source);

        Time += 10;
        await Wait(Time)
    });
}

function RejectEnterRequest(source, club) {
    emitNet("Nightclubs:EnterRequestRejected", source);
}

function AcceptExitRequest(source, club) {
    RemovePlayerFromNightclubSession(source, club);
    emitNet("Nightclubs:ExitRequestAccepted", source);
}

function RemovePlayerFromNightclubSession(source, club) {
    if (!Sessions.has(club.id)) return false;

    var Session = Sessions.get(club.id);
    Session.Players = Session.Players.filter(p => p.id !== source);
    Sessions.delete(club.id);
    Sessions.set(club.id, Session);

    return Sessions; 
}

function GetNightclubPlayerIsIn(source) {
    var currentClub = null;
    Sessions.forEach(async session => {
        if (session.Players.find(p => p.id === source)) {
            currentClub = session.Club;
        }

        await Wait(0);
    });

    return currentClub;
}

onNet("Nightclubs:EnterRequest", (clubString) => {
    var source = global.source;
    var club = JSON.parse(clubString);
    //RejectEnterRequest(source);
    AcceptEnterRequest(source, club);
});

onNet("Nightclubs:ExitRequest", (clubString) => {
    var source = global.source;
    var club = JSON.parse(clubString);
    AcceptExitRequest(source, club);
});

function CMD (source, args) {
    if (args.length < 1) return emitNet("chat:addMessage", source, {
        args: [
            "^1Error", "Not enough arguments"
        ]
    });

    switch (args[0].toLowerCase()) {
        case 'exit':
            if (!GetNightclubPlayerIsIn(source)) return emitNet('chat:addMessage');
            emitNet("Nightclubs:ExitCurrentNightClub", source, {
                args: [
                    "^1Error", "You aren't inside any nightclubs"
                ]
            });
        break;
    }
}

RegisterCommand('club', CMD);
RegisterCommand('clubs', CMD);
RegisterCommand('nightclub', CMD);
RegisterCommand('nightclubs', CMD);
/*RegisterCommand('clubseval', (source, args) => {
    const evaled = eval(args.join(" "));
    console.log(evaled)
})
RegisterCommand('addfakeplayer', (source, args) => {
    AddPlayerToNightclubSession(parseInt(args[0]), {id: parseInt(args[1])});
})*/
